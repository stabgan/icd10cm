name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
      
      - name: Create necessary directories
        run: |
          mkdir -p public/data/chunks
      
      # Note: For a real deployment, you'd need to set up data processing
      # For demo purposes, we'll create a small sample dataset
      - name: Create demo data for GitHub Pages
        run: |
          # Create mock index.json
          echo '{
            "totalCodes": 2,
            "chunkCount": 1,
            "chunkMap": {"A": "A"},
            "lastUpdated": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",
            "processingTime": 0.1
          }' > public/data/index.json
          
          # Create mock search index
          echo '[
            {"code": "A001", "description": "Cholera due to Vibrio cholerae 01, biovar eltor", "category": "Intestinal infectious diseases"},
            {"code": "A014", "description": "Paratyphoid fever, unspecified", "category": "Intestinal infectious diseases"}
          ]' > public/data/search-index.json
          
          # Create mock chunk data for letter A
          echo '[
            {"code": "A001", "description": "Cholera due to Vibrio cholerae 01, biovar eltor", "category": "Intestinal infectious diseases", "detailed_context": "### 1. Disease Overview\n\n*   **Definition and Epidemiology:** Cholera, caused by *Vibrio cholerae* O1 biovar El Tor, is an acute diarrheal illness characterized by profuse watery stools, vomiting, and rapid dehydration. It can lead to hypovolemic shock and acidosis."},
            {"code": "A014", "description": "Paratyphoid fever, unspecified", "category": "Intestinal infectious diseases", "detailed_context": "### 1. Disease Overview\n\n*   **Definition and Epidemiology:** Paratyphoid fever is a bacterial infection caused by one of the Salmonella enterica serotypes Paratyphi A, B, or C. Symptoms typically include fever, headache, abdominal pain, and rash."}
          ]' > public/data/chunks/A.json
      
      - name: Build
        run: npm run build
        env:
          # Set base path for GitHub Pages
          VITE_APP_BASE_URL: '/icd10cm/'
      
      # Add a README note in the dist folder
      - name: Add deployment note
        run: |
          echo "# ICD-10-CM Browser Demo Build" > dist/README.md
          echo "This is a demo build with limited sample data. For a full deployment, follow the instructions in the main repository README." >> dist/README.md
      
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages 